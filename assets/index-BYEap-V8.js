(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function e(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(r){if(r.ep)return;r.ep=!0;const a=e(r);fetch(r.href,a)}})();const I=[240,144,144,144,240,32,96,32,32,112,240,16,240,128,240,240,16,240,16,240,144,144,240,16,16,240,128,240,16,240,240,128,240,144,240,240,16,32,64,64,240,144,240,144,240,240,144,240,16,240,240,144,240,144,144,224,144,224,144,224,240,128,128,128,240,224,144,144,144,224,240,128,240,128,240,240,128,240,128,128];function S(i){const t=(i&61440)>>12,e=(i&3840)>>8,o=(i&240)>>4,r=i&15,a=i&255;let s="";switch(t){case 0:switch(r){case 0:s="CLS";break;case 14:s="RET";break}break;case 1:s=`1) JP nnn (0x${(i&4095).toString(16).toUpperCase().padStart(3,"0")})`;break;case 2:s="2) CALL nnn";break;case 3:s="3) SE Vx, byte";break;case 4:s="4) SNE Vx, byte";break;case 5:s="5) SE Vx, Vy";break;case 6:s=`6) LD Vx, byte (Vx=${e}, byte=${(i&255).toString(16).toUpperCase().padStart(2,"0")})`;break;case 7:s=`7) ADD Vx, byte (0x${(i&255).toString(16).toUpperCase().padStart(2,"0")})`;break;case 8:switch(r){case 0:s=`80) LD Vx, Vy (Vx=${e}, Vy=${o})`;break}break;case 9:s=`9)SNE Vx, Vy (Vx=${e}, Vy=${o})`;break;case 10:s=`A) LD I, address (I=${(i&4095).toString(16).toUpperCase().padStart(3,"0")})`;break;case 11:s=`B) JP V0, nnn (PC=${(i&4095).toString(16).toUpperCase().padStart(3,"0")} = 0x${(i&4095).toString(16).toUpperCase().padStart(3,"0")})`;break;case 12:s=`C) RND Vx, byte (Vx=${e}, byte=${(i&255).toString(16).toUpperCase().padStart(2,"0")} = 0x${(i&255).toString(16).toUpperCase().padStart(2,"0")})`;break;case 13:s=`D)DRW Vx=${e}, Vy=${o}, h=${r}`;break;case 14:switch(a){case 158:s="E9e) SKP Vx";break}break;case 15:switch(r){case 7:s="F07) LD Vx, DT";break}break}return s}class c{static VIDEO_W=64;static VIDEO_H=32;static MEMORY_SIZE=4096;static KEYPAD_SIZE=16;static START_ADDRESS=512;static FONTSET_START_ADDRESS=80;static NIBBLE_3_MASK=61440;static NIBBLE_2_MASK=3840;static NIBBLE_1_MASK=240;static NIBBLE_0_MASK=15;static ARG_0NNN_MASK=4095;static ARG_0XNN_MASK=3840;static BYTES_PER_CHAR=5;memory;keypadMemory;videoMemory;stackMemory;R_PC;R_SP;R_I;REG;OPCODE;R_AUDIO_TIMER;R_DELAY_TIMER;constructor(){this.memory=new Uint8Array(c.MEMORY_SIZE),this.keypadMemory=new Uint8Array(c.KEYPAD_SIZE),this.videoMemory=new Uint8Array(c.VIDEO_W*c.VIDEO_H),this.stackMemory=new Uint16Array(16),this.copyFontset(),this.R_PC=c.START_ADDRESS,this.REG=new Uint8Array(16),this.R_SP=0,this.R_I=0,this.OPCODE=0,this.R_AUDIO_TIMER=0,this.R_DELAY_TIMER=0}copyFontset(){console.log("Copying Fontset"),I.forEach((t,e)=>{this.memory[c.FONTSET_START_ADDRESS+e]=t})}reset(){console.log("Resetting Chip8"),this.memory.fill(0),this.keypadMemory.fill(0),this.videoMemory.fill(0),this.stackMemory.fill(0),this.copyFontset(),this.OPCODE=0,this.REG.fill(0),this.R_AUDIO_TIMER=0,this.R_DELAY_TIMER=0,this.R_PC=c.START_ADDRESS,this.R_I=0,this.R_SP=0}loadRom(t){console.log("Loading ROM"),console.log("romBytes",t),t.forEach((e,o)=>{this.memory[c.START_ADDRESS+o]=e,console.log("memory",c.START_ADDRESS+o,"Hex: "+(c.START_ADDRESS+o).toString(16),"Value: "+e.toString(16))})}cycle(){const t=this.memory[this.R_PC],e=this.memory[this.R_PC+1];this.OPCODE=(t<<8|e)&65535;const o=this.OPCODE.toString(16).padStart(4,"0").toUpperCase(),r=this.R_PC.toString(16).padStart(4,"0").toUpperCase();console.log(`${r}: ${o} ${S(this.OPCODE)}`),this.R_PC+=2;const a=this.OPCODE&c.NIBBLE_0_MASK,s=(this.OPCODE&c.NIBBLE_3_MASK)>>12,E=this.OPCODE&255;switch(s){case 0:switch(a){case 0:this.OP_00E0();break;case 14:this.OP_00EE();break}break;case 1:this.OP_1nnn();break;case 2:this.OP_2nnn();break;case 3:this.OP_3xkk();break;case 4:this.OP_4xkk();break;case 5:this.OP_5xy0();break;case 6:this.OP_6xkk();break;case 7:this.OP_7xkk();break;case 8:switch(a){case 0:this.OP_8xy0();break;case 1:this.OP_8xy1();break;case 2:this.OP_8xy2();break;case 3:this.OP_8xy3();break;case 4:this.OP_8xy4();break;case 5:this.OP_8xy5();break;case 6:this.OP_8xy6();break;case 7:this.OP_8xy7();break;case 14:this.OP_8xyE();break}break;case 9:this.OP_9xy0();break;case 10:this.OP_Annn();break;case 11:this.OP_Bnnn();break;case 12:this.OP_Cxkk();break;case 13:this.OP_Dxyn();break;case 14:switch(E){case 158:this.OP_Ex9E();break;case 161:this.OP_ExA1();break}break;case 15:switch(E){case 7:this.OP_Fx07();break;case 10:this.OP_Fx0A();break;case 21:this.OP_Fx15();break;case 24:this.OP_Fx18();break;case 30:this.OP_Fx1E();break;case 41:this.OP_Fx29();break;case 51:this.OP_Fx33();break;case 85:this.OP_Fx55();break;case 101:this.OP_Fx65();break}break}this.R_DELAY_TIMER>0&&this.R_DELAY_TIMER--,this.R_AUDIO_TIMER>0&&this.R_AUDIO_TIMER--}DO_NOTHING(){}OP_00E0(){this.videoMemory.fill(0)}OP_00EE(){this.R_SP--,this.R_PC=this.stackMemory[this.R_SP]}OP_1nnn(){const t=this.OPCODE&c.ARG_0NNN_MASK;this.R_PC=t}OP_2nnn(){const t=this.OPCODE&c.ARG_0NNN_MASK;this.stackMemory[this.R_SP]=this.R_PC,this.R_SP++,this.R_PC=t}OP_3xkk(){const t=(this.OPCODE&3840)>>8,e=this.OPCODE&255;this.REG[t]==e&&(this.R_PC+=2)}OP_4xkk(){const t=(this.OPCODE&3840)>>8,e=this.OPCODE&255;this.REG[t]!=e&&(this.R_PC+=2)}OP_5xy0(){const t=(this.OPCODE&3840)>>8,e=(this.OPCODE&240)>>4;this.REG[t]==this.REG[e]&&(this.R_PC+=2)}OP_6xkk(){const t=(this.OPCODE&3840)>>8,e=this.OPCODE&255;this.REG[t]=e&255}OP_7xkk(){const t=(this.OPCODE&3840)>>8,e=this.OPCODE&255;this.REG[t]=this.REG[t]+e&255}OP_8xy0(){const t=(this.OPCODE&3840)>>8,e=(this.OPCODE&240)>>4;this.REG[t]=this.REG[e]}OP_8xy1(){const t=(this.OPCODE&3840)>>8,e=(this.OPCODE&240)>>4;this.REG[t]|=this.REG[e]}OP_8xy2(){const t=(this.OPCODE&3840)>>8,e=(this.OPCODE&240)>>4;this.REG[t]&=this.REG[e]}OP_8xy3(){const t=(this.OPCODE&3840)>>8,e=(this.OPCODE&240)>>4;this.REG[t]^=this.REG[e]}OP_8xy4(){const t=(this.OPCODE&3840)>>8,e=(this.OPCODE&240)>>4,o=this.REG[t]+this.REG[e];o>255?this.REG[15]=1:this.REG[15]=0,this.REG[t]=o&255}OP_8xy5(){const t=(this.OPCODE&3840)>>8,e=(this.OPCODE&240)>>4;this.REG[t]>this.REG[e]?this.REG[15]=1:this.REG[15]=0,this.REG[t]-=this.REG[e]}OP_8xy6(){const t=(this.OPCODE&3840)>>8;this.REG[15]=this.REG[t]&1,this.REG[t]=this.REG[t]>>1}OP_8xy7(){const t=(this.OPCODE&3840)>>8,e=(this.OPCODE&240)>>4;this.REG[e]>=this.REG[t]?this.REG[15]=1:this.REG[15]=0,this.REG[t]=this.REG[e]-this.REG[t]}OP_8xyE(){const t=(this.OPCODE&3840)>>8,e=(this.REG[t]&128)>>7;this.REG[15]=e,this.REG[t]<<=1}OP_9xy0(){const t=(this.OPCODE&3840)>>8,e=(this.OPCODE&240)>>4;this.REG[t]!=this.REG[e]&&(this.R_PC+=2)}OP_Annn(){const t=this.OPCODE&4095;this.R_I=t}OP_Bnnn(){const t=this.OPCODE&4095;this.R_PC=this.REG[0]+t}OP_Cxkk(){const t=(this.OPCODE&3840)>>8,e=this.OPCODE&255;this.REG[t]=this.getRandomByte()&e}OP_Dxyn(){const t=(this.OPCODE&3840)>>8,e=(this.OPCODE&240)>>4,o=this.OPCODE&15;this.REG[15]=0;const r=this.REG[t]%c.VIDEO_W,a=this.REG[e]%c.VIDEO_H;for(let s=0;s<o;++s){const E=this.memory[this.R_I+s];for(let R=0;R<8;R++){const l=E&128>>R,m=(r+R)%c.VIDEO_W,_=(a+s)%c.VIDEO_H*c.VIDEO_W+m;l&&(this.videoMemory[_]===1&&(this.REG[15]=1),this.videoMemory[_]^=1)}}}OP_Ex9E(){const t=(this.OPCODE&3840)>>8,e=this.REG[t];this.keypadMemory[e]&&(this.R_PC+=2)}OP_ExA1(){const t=(this.OPCODE&3840)>>8,e=this.REG[t];this.keypadMemory[e]||(this.R_PC+=2)}OP_Fx0A(){const t=(this.OPCODE&3840)>>8;let e=!1;for(let o=0;o<16;o++)if(this.keypadMemory[o]){this.REG[t]=o,e=!0;break}e||(this.R_PC-=2)}OP_Fx07(){const t=(this.OPCODE&3840)>>8;this.REG[t]=this.R_DELAY_TIMER}OP_Fx15(){const t=(this.OPCODE&3840)>>8;this.R_DELAY_TIMER=this.REG[t]}OP_Fx18(){const t=(this.OPCODE&3840)>>8;this.R_AUDIO_TIMER=this.REG[t]}OP_Fx1E(){const t=(this.OPCODE&3840)>>8;this.R_I+=this.REG[t]}OP_Fx29(){const t=(this.OPCODE&3840)>>8,e=this.REG[t];this.R_I=c.FONTSET_START_ADDRESS+c.BYTES_PER_CHAR*e}OP_Fx33(){const t=(this.OPCODE&3840)>>8,e=this.REG[t];this.memory[this.R_I+0]=e/100,this.memory[this.R_I+1]=e/10%10,this.memory[this.R_I+2]=e%10}OP_Fx55(){const t=(this.OPCODE&3840)>>8;for(let e=0;e<=t;++e)this.memory[this.R_I+e]=this.REG[e]}OP_Fx65(){const t=(this.OPCODE&3840)>>8;for(let e=0;e<=t;++e)this.REG[e]=this.memory[this.R_I+e]}getRandomByte(){return Math.floor(Math.random()*256)}}const p=10,V=100,M=2,n=new c;window.CHIP8=n;const P=document.getElementById("canvas");P.width=c.VIDEO_W*p;P.height=c.VIDEO_H*p;const k=P.getContext("2d");k.fillStyle="black";k.fillRect(0,0,P.width,P.height);let d=!1;const h=new Map,g={lastTimestampMs:0};function y(i,t,e){const o=document.getElementById(i);if(!o)return;const r=t.toString(16).toUpperCase().padStart(e,"0");"value"in o,o.value=r}function C(i,t){const e=document.getElementById(i);e&&("value"in e,e.value=t)}function A(){y("op-reg",n.OPCODE,4),C("op-mne",`${S(n.OPCODE)}`),y("pc-reg",n.R_PC,4),y("i-reg",n.R_I,4),y("sp-reg",n.R_SP,2),y("dt-reg",n.R_DELAY_TIMER,2),y("st-reg",n.R_AUDIO_TIMER,2);for(let i=0;i<16;i++)y(`v${i}-reg`,n.REG[i],2)}function D(){const i=document.getElementById("memory-view");if(!i)return;let t="";const e=16,o=n.memory.length;for(let l=0;l<o;l+=e){const m=l.toString(16).toUpperCase().padStart(4,"0");t+=`${m}: `;for(let O=0;O<e;O++)if(l+O<o){const _=l+O,x=n.memory[_].toString(16).toUpperCase().padStart(2,"0");_===n.R_PC?t+=`[${x}]`:_===n.R_PC+1?t+=`[${x}]`:t+=x+" "}else t+="   ";t+=" | ";for(let O=0;O<e;O++)if(l+O<o){const _=n.memory[l+O],f=_>=32&&_<=126?String.fromCharCode(_):".";t+=f}t+=`
`}i.value=t;const r=Math.floor(n.R_PC/e),a=Math.ceil(o/e),s=i.scrollHeight/a,E=i.clientHeight,R=r*s-E/2+s/2;i.scrollTop=Math.max(0,R)}function G(){y("op-reg",0,4),C("op-mne",""),y("pc-reg",c.START_ADDRESS,4),y("i-reg",0,4),y("sp-reg",0,2),y("dt-reg",0,2),y("st-reg",0,2);for(let i=0;i<16;i++)y(`v${i}-reg`,0,2)}function b(){const i=document.createElement("canvas");i.width=c.VIDEO_W,i.height=c.VIDEO_H;const t=i.getContext("2d"),e=t.getImageData(0,0,c.VIDEO_W,c.VIDEO_H);for(let o=0;o<c.VIDEO_W*c.VIDEO_H;o++){const r=o*4,a=n.videoMemory[o];e.data[r]=a*255,e.data[r+1]=a*255,e.data[r+2]=a*255,e.data[r+3]=255}t.putImageData(e,0,0),k.imageSmoothingEnabled=!1,k.drawImage(i,0,0,c.VIDEO_W,c.VIDEO_H,0,0,P.width,P.height)}function u(i){if(i-g.lastTimestampMs<V){d&&requestAnimationFrame(u);return}g.lastTimestampMs=i,n.keypadMemory[0]=h.get("0")?1:0,n.keypadMemory[1]=h.get("1")?1:0,n.keypadMemory[2]=h.get("2")?1:0,n.keypadMemory[3]=h.get("3")?1:0,n.keypadMemory[4]=h.get("4")?1:0,n.keypadMemory[5]=h.get("5")?1:0,n.keypadMemory[6]=h.get("6")?1:0,n.keypadMemory[7]=h.get("7")?1:0,n.keypadMemory[8]=h.get("8")?1:0,n.keypadMemory[9]=h.get("9")?1:0,n.keypadMemory[10]=h.get("A")?1:0,n.keypadMemory[11]=h.get("B")?1:0,n.keypadMemory[12]=h.get("C")?1:0,n.keypadMemory[13]=h.get("D")?1:0,n.keypadMemory[14]=h.get("E")?1:0,n.keypadMemory[15]=h.get("F")?1:0;for(let e=0;e<M;e++)n.cycle();b(),d&&requestAnimationFrame(u)}async function T(){(await(await fetch("/chip8-web/romList.json")).json()).forEach(a=>{const s=document.createElement("option");s.value=a.name,s.textContent=a.name,document.getElementById("rom-select")?.appendChild(s)}),document.getElementById("load-rom-button")?.addEventListener("click",async()=>{const E=`/chip8-web/roms/${document.getElementById("rom-select").value}`,l=await(await fetch(E)).arrayBuffer(),m=new Uint8Array(l);d=!1,n.reset(),n.loadRom(m),D()});const e=document.getElementById("upload-rom-button"),o=document.getElementById("rom-upload-input");e?.addEventListener("click",()=>{o?.click()}),o?.addEventListener("change",async a=>{const s=a.target,E=s.files?.[0];if(!E)return;const R=await E.arrayBuffer(),l=new Uint8Array(R),m=document.getElementById("rom-select"),O=document.createElement("option");O.value=E.name,O.textContent=E.name,O.setAttribute("data-custom","true"),m.appendChild(O),m.value=E.name,d=!1,n.reset(),n.loadRom(l),D(),s.value=""}),document.querySelectorAll(".keypad-button").forEach(a=>{a.addEventListener("click",()=>{const s=a.dataset.key;if(s){const E=h.get(s)||!1;h.set(s,!E),a.classList.toggle("active")}})}),document.getElementById("run-button")?.addEventListener("click",()=>{d=!0,requestAnimationFrame(u)}),document.getElementById("pause-button")?.addEventListener("click",()=>{d=!1}),document.getElementById("cycle-button")?.addEventListener("click",()=>{d=!1,D(),n.cycle(),A(),b()}),document.getElementById("reset-button")?.addEventListener("click",()=>{d=!1,n.reset(),G(),D()}),window.addEventListener("keydown",a=>{const s=a.key.toUpperCase();console.log(s),h.set(s,!0)}),window.addEventListener("keyup",a=>{const s=a.key.toUpperCase();console.log(s),h.set(s,!1)})}window.addEventListener("DOMContentLoaded",()=>{T(),D()});
