(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();const C=[240,144,144,144,240,32,96,32,32,112,240,16,240,128,240,240,16,240,16,240,144,144,240,16,16,240,128,240,16,240,240,128,240,144,240,240,16,32,64,64,240,144,240,144,240,240,144,240,16,240,240,144,240,144,144,224,144,224,144,224,240,128,128,128,240,224,144,144,144,224,240,128,240,128,240,240,128,240,128,128];function D(a){const t=(a&61440)>>12,e=(a&3840)>>8,i=(a&240)>>4,s=a&15;let o="";switch(t){case 0:switch(s){case 0:o="CLS";break;case 14:o="RET";break}break;case 1:o="JP nnn";break;case 2:o="CALL nnn";break;case 3:o="SE Vx, byte";break;case 4:o="SNE Vx, byte";break;case 5:o="SE Vx, Vy";break;case 6:o="LD Vx, byte";break;case 7:o="ADD Vx, byte";break;case 8:switch(s){case 0:o="LD Vx, Vy";break}break;case 9:o="SNE Vx, Vy";break;case 10:o="LD I, address";break;case 11:o="JP V0, nnn";break;case 12:o="RND Vx, byte";break;case 13:o=`DRW Vx=${e}, Vy=${i}, h=${s}`;break;case 14:switch(s){case 158:o="SKP Vx";break}break;case 15:switch(s){case 7:o="LD Vx, DT";break}break}return o}class n{static VIDEO_W=64;static VIDEO_H=32;static MEMORY_SIZE=4096;static KEYPAD_SIZE=16;static START_ADDRESS=512;static FONTSET_START_ADDRESS=80;static NIBBLE_3_MASK=61440;static NIBBLE_2_MASK=3840;static NIBBLE_1_MASK=240;static NIBBLE_0_MASK=15;static ARG_0NNN_MASK=4095;static ARG_0XNN_MASK=3840;static BYTES_PER_CHAR=5;memory;keypadMemory;videoMemory;stackMemory;R_PC;R_SP;R_I;REG;OPCODE;R_AUDIO_TIMER;R_DELAY_TIMER;constructor(){this.memory=new Uint8Array(n.MEMORY_SIZE),this.keypadMemory=new Uint8Array(n.KEYPAD_SIZE),this.videoMemory=new Uint8Array(n.VIDEO_W*n.VIDEO_H),this.stackMemory=new Uint16Array(16),this.copyFontset(),this.R_PC=n.START_ADDRESS,this.REG=new Uint8Array(16),this.R_SP=0,this.R_I=0,this.OPCODE=0,this.R_AUDIO_TIMER=0,this.R_DELAY_TIMER=0}copyFontset(){console.log("Copying Fontset"),C.forEach((t,e)=>{this.memory[n.FONTSET_START_ADDRESS+e]=t})}reset(){console.log("Resetting Chip8"),this.memory.fill(0),this.keypadMemory.fill(0),this.videoMemory.fill(0),this.stackMemory.fill(0),this.copyFontset(),this.OPCODE=0,this.REG.fill(0),this.R_AUDIO_TIMER=0,this.R_DELAY_TIMER=0,this.R_PC=n.START_ADDRESS,this.R_I=0,this.R_SP=0}loadRom(t){console.log("Loading ROM"),console.log("romBytes",t),t.forEach((e,i)=>{this.memory[n.START_ADDRESS+i]=e,console.log("memory",n.START_ADDRESS+i,"Hex: "+(n.START_ADDRESS+i).toString(16),"Value: "+e.toString(16))})}cycle(){const t=this.memory[this.R_PC],e=this.memory[this.R_PC+1];this.OPCODE=(t<<8|e)&65535;const i=this.OPCODE.toString(16).padStart(4,"0").toUpperCase(),s=this.R_PC.toString(16).padStart(4,"0").toUpperCase();console.log(`${s}: ${i} ${D(this.OPCODE)}`),this.R_PC+=2;const o=this.OPCODE&n.NIBBLE_0_MASK,r=(this.OPCODE&n.NIBBLE_3_MASK)>>12,_=this.OPCODE&255;switch(r){case 0:switch(o){case 0:this.OP_00E0();break;case 14:this.OP_00EE();break}break;case 1:this.OP_1nnn();break;case 2:this.OP_2nnn();break;case 3:this.OP_3xkk();break;case 4:this.OP_4xkk();break;case 5:this.OP_5xy0();break;case 6:this.OP_6xkk();break;case 7:this.OP_7xkk();break;case 8:switch(o){case 0:this.OP_8xy0();break;case 1:this.OP_8xy1();break;case 2:this.OP_8xy2();break;case 3:this.OP_8xy3();break;case 4:this.OP_8xy4();break;case 5:this.OP_8xy5();break;case 6:this.OP_8xy6();break;case 7:this.OP_8xy7();break;case 14:this.OP_8xyE();break}break;case 9:this.OP_9xy0();break;case 10:this.OP_Annn();break;case 11:this.OP_Bnnn();break;case 12:this.OP_Cxkk();break;case 13:this.OP_Dxyn();break;case 14:switch(o){case 158:this.OP_Ex9E();break;case 161:this.OP_ExA1();break}break;case 15:switch(_){case 7:this.OP_Fx07();break;case 10:this.OP_Fx0A();break;case 21:this.OP_Fx15();break;case 24:this.OP_Fx18();break;case 30:this.OP_Fx1E();break;case 41:this.OP_Fx29();break;case 51:this.OP_Fx33();break;case 85:this.OP_Fx55();break;case 101:this.OP_Fx65();break}break}this.R_DELAY_TIMER>0&&this.R_DELAY_TIMER--,this.R_AUDIO_TIMER>0&&this.R_AUDIO_TIMER--}DO_NOTHING(){}OP_00E0(){this.videoMemory.fill(0)}OP_00EE(){this.R_SP--,this.R_PC=this.stackMemory[this.R_SP]}OP_1nnn(){const t=this.OPCODE&n.ARG_0NNN_MASK;this.R_PC=t}OP_2nnn(){const t=this.OPCODE&n.ARG_0NNN_MASK;this.stackMemory[this.R_SP]=this.R_PC,this.R_SP++,this.R_PC=t}OP_3xkk(){const t=(this.OPCODE&3840)>>8,e=this.OPCODE&255;this.REG[t]==e&&(this.R_PC+=2)}OP_4xkk(){const t=(this.OPCODE&3840)>>8,e=this.OPCODE&255;this.REG[t]!=e&&(this.R_PC+=2)}OP_5xy0(){const t=(this.OPCODE&3840)>>8,e=(this.OPCODE&240)>>4;this.REG[t]==this.REG[e]&&(this.R_PC+=2)}OP_6xkk(){const t=(this.OPCODE&3840)>>8,e=this.OPCODE&255;this.REG[t]=e&255}OP_7xkk(){const t=(this.OPCODE&3840)>>8,e=this.OPCODE&255;this.REG[t]=this.REG[t]+e&255}OP_8xy0(){const t=(this.OPCODE&3840)>>8,e=(this.OPCODE&240)>>4;this.REG[t]=this.REG[e]}OP_8xy1(){const t=(this.OPCODE&3840)>>8,e=(this.OPCODE&240)>>4;this.REG[t]|=this.REG[e]}OP_8xy2(){const t=(this.OPCODE&3840)>>8,e=(this.OPCODE&240)>>4;this.REG[t]&=this.REG[e]}OP_8xy3(){const t=(this.OPCODE&3840)>>8,e=(this.OPCODE&240)>>4;this.REG[t]^=this.REG[e]}OP_8xy4(){const t=(this.OPCODE&3840)>>8,e=(this.OPCODE&240)>>4,i=this.REG[t]+this.REG[e];i>255?this.REG[15]=1:this.REG[15]=0,this.REG[t]=i&255}OP_8xy5(){const t=(this.OPCODE&3840)>>8,e=(this.OPCODE&240)>>4;this.REG[t]>this.REG[e]?this.REG[15]=1:this.REG[15]=0,this.REG[t]-=this.REG[e]}OP_8xy6(){const t=(this.OPCODE&3840)>>8;this.REG[15]=this.REG[t]&1,this.REG[t]=this.REG[t]>>1}OP_8xy7(){const t=(this.OPCODE&3840)>>8,e=(this.OPCODE&240)>>4;this.REG[e]>=this.REG[t]?this.REG[15]=1:this.REG[15]=0,this.REG[t]=this.REG[e]-this.REG[t]}OP_8xyE(){const t=(this.OPCODE&3840)>>8,e=(this.REG[t]&128)>>7;this.REG[15]=e,this.REG[t]<<=1}OP_9xy0(){const t=(this.OPCODE&3840)>>8,e=(this.OPCODE&240)>>4;this.REG[t]!=this.REG[e]&&(this.R_PC+=2)}OP_Annn(){const t=this.OPCODE&4095;this.R_I=t}OP_Bnnn(){const t=this.OPCODE&4095;this.R_PC=this.REG[0]+t}OP_Cxkk(){const t=(this.OPCODE&3840)>>8,e=this.OPCODE&255;this.REG[t]=this.getRandomByte()&e}OP_Dxyn(){const t=(this.OPCODE&3840)>>8,e=(this.OPCODE&240)>>4,i=this.OPCODE&15;this.REG[15]=0;const s=this.REG[t]%n.VIDEO_W,o=this.REG[e]%n.VIDEO_H;for(let r=0;r<i;++r){const _=this.memory[this.R_I+r];for(let O=0;O<8;O++){const u=_&128>>O,f=(s+O)%n.VIDEO_W,l=(o+r)%n.VIDEO_H*n.VIDEO_W+f;u&&(this.videoMemory[l]===1&&(this.REG[15]=1),this.videoMemory[l]^=1)}}}OP_Ex9E(){const t=(this.OPCODE&3840)>>8,e=this.REG[t];this.keypadMemory[e]&&(this.R_PC+=2)}OP_ExA1(){const t=(this.OPCODE&3840)>>8,e=this.REG[t];this.keypadMemory[e]||(this.R_PC+=2)}OP_Fx0A(){const t=(this.OPCODE&3840)>>8;let e=!1;for(let i=0;i<16;i++)if(this.keypadMemory[i]){this.REG[t]=i,e=!0;break}e||(this.R_PC-=2)}OP_Fx07(){const t=(this.OPCODE&3840)>>8;this.REG[t]=this.R_DELAY_TIMER}OP_Fx15(){const t=(this.OPCODE&3840)>>8;this.R_DELAY_TIMER=this.REG[t]}OP_Fx18(){const t=(this.OPCODE&3840)>>8;this.R_AUDIO_TIMER=this.REG[t]}OP_Fx1E(){const t=(this.OPCODE&3840)>>8;this.R_I+=this.REG[t]}OP_Fx29(){const t=(this.OPCODE&3840)>>8,e=this.REG[t];this.R_I=n.FONTSET_START_ADDRESS+n.BYTES_PER_CHAR*e}OP_Fx33(){const t=(this.OPCODE&3840)>>8,e=this.REG[t];this.memory[this.R_I+0]=e/100,this.memory[this.R_I+1]=e/10%10,this.memory[this.R_I+2]=e%10}OP_Fx55(){const t=(this.OPCODE&3840)>>8;for(let e=0;e<=t;++e)this.memory[this.R_I+e]=this.REG[e]}OP_Fx65(){const t=(this.OPCODE&3840)>>8;for(let e=0;e<=t;++e)this.REG[e]=this.memory[this.R_I+e]}getRandomByte(){return Math.floor(Math.random()*256)}}const k=10,I=100,S=2,c=new n;window.CHIP8=c;const P=document.getElementById("canvas");P.width=n.VIDEO_W*k;P.height=n.VIDEO_H*k;const d=P.getContext("2d");let h=!1;const R=new Map,m={lastTimestampMs:0};function E(a,t,e){const i=document.getElementById(a);if(!i)return;const s=t.toString(16).toUpperCase().padStart(e,"0");"value"in i,i.value=s}function V(a,t){const e=document.getElementById(a);e&&("value"in e,e.value=t)}function x(){E("op-reg",c.OPCODE,4),V("op-mne",`${D(c.OPCODE)}`),E("pc-reg",c.R_PC,4),E("i-reg",c.R_I,4),E("sp-reg",c.R_SP,2),E("dt-reg",c.R_DELAY_TIMER,2),E("st-reg",c.R_AUDIO_TIMER,2);for(let a=0;a<16;a++)E(`v${a}-reg`,c.REG[a],2)}function b(){const a=document.createElement("canvas");a.width=n.VIDEO_W,a.height=n.VIDEO_H;const t=a.getContext("2d"),e=t.getImageData(0,0,n.VIDEO_W,n.VIDEO_H);for(let i=0;i<n.VIDEO_W*n.VIDEO_H;i++){const s=i*4,o=c.videoMemory[i];e.data[s]=o*255,e.data[s+1]=o*255,e.data[s+2]=o*255,e.data[s+3]=255}t.putImageData(e,0,0),d.imageSmoothingEnabled=!1,d.drawImage(a,0,0,n.VIDEO_W,n.VIDEO_H,0,0,P.width,P.height)}function y(a){if(a-m.lastTimestampMs<I){h&&requestAnimationFrame(y);return}m.lastTimestampMs=a,c.keypadMemory[0]=R.get("1")?1:0;for(let e=0;e<S;e++)c.cycle();x(),b(),h&&requestAnimationFrame(y)}async function A(){const t=await(await fetch("/romList.json")).json();console.log(t),t.forEach(i=>{const s=document.createElement("option");s.value=i.name,s.textContent=i.name,document.getElementById("rom-select")?.appendChild(s)}),document.getElementById("load-rom-button")?.addEventListener("click",async()=>{const o=`/roms/${document.getElementById("rom-select").value}`,_=await(await fetch(o)).arrayBuffer(),O=new Uint8Array(_);h=!1,c.reset(),c.loadRom(O)}),document.querySelectorAll("#keyboard-button").forEach(i=>{i.addEventListener("mouseup",()=>{const s=i.dataset.key;R.set(s||"",!1)}),i.addEventListener("mousedown",()=>{const s=i.dataset.key;R.set(s||"",!0)})}),document.getElementById("run-button")?.addEventListener("click",()=>{h=!0,requestAnimationFrame(y)}),document.getElementById("pause-button")?.addEventListener("click",()=>{h=!1}),document.getElementById("cycle-button")?.addEventListener("click",()=>{h=!1,c.cycle(),x(),b()}),document.getElementById("reset-button")?.addEventListener("click",()=>{h=!1,c.reset()}),window.addEventListener("keydown",i=>{const s=i.key.toUpperCase();console.log(s),R.set(s,!0)}),window.addEventListener("keyup",i=>{const s=i.key.toUpperCase();console.log(s),R.set(s,!1)})}window.addEventListener("DOMContentLoaded",()=>{A()});
